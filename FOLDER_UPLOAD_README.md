# 文件夹上传功能实现说明

## 实现方案

基于项目现有架构，采用**前端解析 + 单文件逐个上传**的方案实现文件夹上传功能。

## 核心设计思路

### 1. 前端文件夹解析
- 使用 `DataTransferItem.webkitGetAsEntry()` API 读取文件夹结构
- 递归遍历所有子文件夹和文件
- 保持完整的相对路径信息（如 `folder1/subfolder/file.jpg`）

### 2. 单文件逐个上传
- **不修改后端**：后端继续使用 `formdata.get('file')` 处理单文件
- **逐个上传**：前端按顺序逐个上传文件，避免并行导致的卡顿
- **路径传递**：通过两种方式传递文件夹路径：
  1. URL 参数 `uploadFolder`（后端优先使用）
  2. 文件名包含完整路径（后端备用提取）

### 3. 文件夹结构保持
- 后端通过 `Directory` 字段存储文件夹路径
- 每个文件的元数据中记录其所在目录
- 文件列表可通过 `directory` 字段查询和展示

## 技术实现细节

### 文件路径处理

```javascript
// 示例：上传文件 "folder1/subfolder/video.mp4"
relativePath = "folder1/subfolder/video.mp4"
folderPath = "folder1/subfolder"  // 通过 uploadFolder 参数传递
fileName = "video.mp4"  // 文件名

// 后端接收：
// - uploadFolder: "folder1/subfolder"
// - file.name: "folder1/subfolder/video.mp4" (完整路径)
// - Directory: "folder1/subfolder/" (存储到元数据)
```

### 大文件分块上传

- 文件 > 20MB 自动使用分块上传
- 分块上传流程：
  1. 初始化：创建上传会话
  2. 上传分块：将文件切分为 20MB 分块
  3. 合并：所有分块上传完成后合并
  4. 路径传递：合并时也传递文件夹路径

### 进度显示

- 文件扫描阶段：显示"正在扫描文件夹结构..."
- 上传阶段：
  - 显示当前文件序号/总文件数
  - 显示当前文件名和大小
  - 显示总进度百分比（基于文件大小）
  - 大文件显示分块上传进度

## 与项目架构的兼容性

### ✅ 兼容现有后端
- 不修改后端代码
- 使用现有的单文件上传接口
- 兼容所有存储渠道（Telegram、R2、S3）

### ✅ 兼容数据库设计
- 使用现有的 `Directory` 字段存储文件夹路径
- 不需要额外的文件夹元数据表
- 通过查询 `directory` 字段可以获取文件夹下的所有文件

### ✅ 兼容 Cloudflare 部署
- 仅使用标准 Web API
- 不依赖 Node.js 特定功能
- 可在 Cloudflare Pages 上直接运行

## 使用限制

1. **浏览器兼容性**：需要支持 `webkitGetAsEntry()` API
   - Chrome/Edge: ✅ 支持
   - Firefox: ✅ 支持（最新版本）
   - Safari: ⚠️ 部分支持

2. **文件大小限制**：
   - 单个文件最大约 1GB（50个分块 × 20MB）
   - 可通过修改 `CHUNK_SIZE` 和分块数量限制调整

3. **文件夹结构**：
   - 支持嵌套文件夹
   - 文件夹路径通过 `Directory` 字段存储
   - 不创建实际的文件夹对象，仅通过路径关联

## 与 WebDAV 的区别

- **WebDAV 方式**：需要外部客户端，支持完整的文件夹操作（创建、删除、移动）
- **本实现方式**：Web 界面直接拖拽，仅支持上传，通过路径模拟文件夹结构

## 未来优化方向

1. **文件夹元数据管理**：如需要，可添加文件夹表记录文件夹信息
2. **批量操作优化**：可考虑添加批量上传接口，减少请求次数
3. **断点续传**：大文件上传失败后可恢复
4. **文件夹预览**：在文件列表中按文件夹分组显示

## 测试建议

1. 测试小文件夹（< 10 个文件）
2. 测试包含大文件的文件夹（视频文件）
3. 测试嵌套文件夹结构
4. 测试不同浏览器兼容性
5. 验证文件夹路径在后端正确存储

